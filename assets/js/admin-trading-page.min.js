(function($){"use strict";function initTradingPage(){console.log("TradePress Trading Page JS loaded");if($(".tradepress-tabs-container").length>0){initTabs()}if($("#tradepress-portfolio").length>0){initPortfolioView()}if($("#tradepress-trade-history").length>0){initTradeHistory()}if($("#tradepress-manual-trade-form").length>0){initManualTradeForm()}if($("#tradepress-orders").length>0){initOrderManagement()}}function initTabs(){$(".nav-tab").on("click",function(e){e.preventDefault();var tabId=$(this).data("tab");$(".nav-tab").removeClass("nav-tab-active");$(this).addClass("nav-tab-active");$(".tab-content").removeClass("active");$("#"+tabId).addClass("active");var newUrl=updateQueryStringParameter(window.location.href,"tab",tabId);window.history.pushState({path:newUrl},"",newUrl)});var urlParams=new URLSearchParams(window.location.search);var activeTab=urlParams.get("tab");if(activeTab){$('.nav-tab[data-tab="'+activeTab+'"]').trigger("click")}else{$(".nav-tab").first().trigger("click")}}function initPortfolioView(){var portfolioRefreshInterval=6e4;function refreshPortfolioData(){$.ajax({url:tradepress_ajax.ajax_url,type:"POST",data:{action:"tradepress_refresh_portfolio",nonce:tradepress_ajax.nonce},success:function(response){if(response.success){updatePortfolioDisplay(response.data)}},error:function(){console.error("Failed to refresh portfolio data")}})}setInterval(refreshPortfolioData,portfolioRefreshInterval);refreshPortfolioData();function updatePortfolioDisplay(data){if(!data||!data.positions)return;$.each(data.positions,function(index,position){var $row=$("#position-"+position.id);if($row.length){$row.find(".position-value").text(position.current_value);$row.find(".position-pl").text(position.unrealized_pl);if(parseFloat(position.unrealized_pl)>=0){$row.find(".position-pl").removeClass("negative").addClass("positive")}else{$row.find(".position-pl").removeClass("positive").addClass("negative")}}});if(data.totals){$("#portfolio-total-value").text(data.totals.value);$("#portfolio-total-pl").text(data.totals.unrealized_pl);if(parseFloat(data.totals.unrealized_pl)>=0){$("#portfolio-total-pl").removeClass("negative").addClass("positive")}else{$("#portfolio-total-pl").removeClass("positive").addClass("negative")}}}}function initTradeHistory(){if($.fn.daterangepicker&&$("#trade-history-date-range").length){$("#trade-history-date-range").daterangepicker({ranges:{Today:[moment(),moment()],Yesterday:[moment().subtract(1,"days"),moment().subtract(1,"days")],"Last 7 Days":[moment().subtract(6,"days"),moment()],"Last 30 Days":[moment().subtract(29,"days"),moment()],"This Month":[moment().startOf("month"),moment().endOf("month")],"Last Month":[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")]},startDate:moment().subtract(29,"days"),endDate:moment()},function(start,end){$("#trade-history-date-range span").html(start.format("MMMM D, YYYY")+" - "+end.format("MMMM D, YYYY"));fetchTradeHistory(start.format("YYYY-MM-DD"),end.format("YYYY-MM-DD"))})}$("#trade-history-filters").on("submit",function(e){e.preventDefault();var filters=$(this).serialize();fetchTradeHistory(null,null,filters)});function fetchTradeHistory(startDate,endDate,additionalFilters){var data={action:"tradepress_fetch_trade_history",nonce:tradepress_ajax.nonce};if(startDate&&endDate){data.start_date=startDate;data.end_date=endDate}if(additionalFilters){var filterData=new URLSearchParams(additionalFilters);filterData.forEach(function(value,key){data[key]=value})}$.ajax({url:tradepress_ajax.ajax_url,type:"POST",data:data,beforeSend:function(){$("#trade-history-table").addClass("loading")},success:function(response){$("#trade-history-table").removeClass("loading");if(response.success){updateTradeHistoryTable(response.data)}else{console.error("Error fetching trade history:",response.data)}},error:function(){$("#trade-history-table").removeClass("loading");console.error("Failed to fetch trade history")}})}function updateTradeHistoryTable(data){var $tableBody=$("#trade-history-table tbody");$tableBody.empty();if(!data||data.length===0){$tableBody.append('<tr><td colspan="6">No trades found for the selected period.</td></tr>');return}$.each(data,function(index,trade){var row="<tr>";row+="<td>"+trade.date+"</td>";row+="<td>"+trade.symbol+"</td>";row+="<td>"+trade.type+"</td>";row+="<td>"+trade.quantity+"</td>";row+="<td>"+trade.price+"</td>";row+='<td class="'+(parseFloat(trade.pl)>=0?"positive":"negative")+'">'+trade.pl+"</td>";row+="</tr>";$tableBody.append(row)})}}function initManualTradeForm(){if($.fn.autocomplete&&$("#manual-trade-symbol").length){$("#manual-trade-symbol").autocomplete({source:function(request,response){$.ajax({url:tradepress_ajax.ajax_url,type:"POST",dataType:"json",data:{action:"tradepress_symbol_lookup",term:request.term,nonce:tradepress_ajax.nonce},success:function(data){response(data)}})},minLength:2,select:function(event,ui){$("#manual-trade-symbol-id").val(ui.item.id);fetchSymbolPrice(ui.item.id)}})}$("#manual-trade-quantity, #manual-trade-price").on("input",calculateOrderTotal);$("#manual-trade-order-type").on("change",function(){var orderType=$(this).val();$(".conditional-field").hide();switch(orderType){case"market":$(".field-market-price").show();break;case"limit":$(".field-limit-price").show();break;case"stop":$(".field-stop-price").show();break;case"stop_limit":$(".field-stop-price").show();$(".field-limit-price").show();break}calculateOrderTotal()});$("#manual-trade-form").on("submit",function(e){e.preventDefault();if(confirm("Are you sure you want to place this order?")){$.ajax({url:tradepress_ajax.ajax_url,type:"POST",data:$(this).serialize()+"&action=tradepress_place_order&nonce="+tradepress_ajax.nonce,beforeSend:function(){$("#manual-trade-submit").prop("disabled",true).addClass("loading")},success:function(response){$("#manual-trade-submit").prop("disabled",false).removeClass("loading");if(response.success){showNotice("success","Order placed successfully!");$("#manual-trade-form")[0].reset();if($("#tradepress-orders").length){refreshOrders()}}else{showNotice("error","Failed to place order: "+response.data)}},error:function(){$("#manual-trade-submit").prop("disabled",false).removeClass("loading");showNotice("error","Failed to place order due to a server error.")}})}});function fetchSymbolPrice(symbolId){$.ajax({url:tradepress_ajax.ajax_url,type:"POST",data:{action:"tradepress_get_symbol_price",symbol_id:symbolId,nonce:tradepress_ajax.nonce},success:function(response){if(response.success){$("#manual-trade-price").val(response.data.price);calculateOrderTotal()}}})}function calculateOrderTotal(){var quantity=parseFloat($("#manual-trade-quantity").val())||0;var price=parseFloat($("#manual-trade-price").val())||0;var total=quantity*price;total=total.toFixed(2);$("#manual-trade-total").text(total)}}function initOrderManagement(){var ordersRefreshInterval=3e4;setInterval(refreshOrders,ordersRefreshInterval);refreshOrders();$("#tradepress-orders").on("click",".cancel-order",function(e){e.preventDefault();var orderId=$(this).data("order-id");if(confirm("Are you sure you want to cancel this order?")){cancelOrder(orderId)}});function refreshOrders(){$.ajax({url:tradepress_ajax.ajax_url,type:"POST",data:{action:"tradepress_get_orders",nonce:tradepress_ajax.nonce},success:function(response){if(response.success){updateOrdersTable(response.data)}else{console.error("Error fetching orders:",response.data)}},error:function(){console.error("Failed to fetch orders")}})}function updateOrdersTable(data){var $tableBody=$("#tradepress-orders tbody");$tableBody.empty();if(!data||data.length===0){$tableBody.append('<tr><td colspan="7">No open orders.</td></tr>');return}$.each(data,function(index,order){var row='<tr data-order-id="'+order.id+'">';row+="<td>"+order.symbol+"</td>";row+="<td>"+order.type+"</td>";row+="<td>"+(order.side==="buy"?"Buy":"Sell")+"</td>";row+="<td>"+order.quantity+"</td>";row+="<td>"+(order.price||"Market")+"</td>";row+="<td>"+order.status+"</td>";row+='<td class="order-actions">';if(order.status==="open"||order.status==="pending"){row+='<button class="button cancel-order" data-order-id="'+order.id+'">Cancel</button>'}row+="</td>";row+="</tr>";$tableBody.append(row)})}function cancelOrder(orderId){$.ajax({url:tradepress_ajax.ajax_url,type:"POST",data:{action:"tradepress_cancel_order",order_id:orderId,nonce:tradepress_ajax.nonce},beforeSend:function(){$('tr[data-order-id="'+orderId+'"]').addClass("loading")},success:function(response){$('tr[data-order-id="'+orderId+'"]').removeClass("loading");if(response.success){showNotice("success","Order cancelled successfully");refreshOrders()}else{showNotice("error","Failed to cancel order: "+response.data)}},error:function(){$('tr[data-order-id="'+orderId+'"]').removeClass("loading");showNotice("error","Failed to cancel order due to a server error")}})}}function updateQueryStringParameter(uri,key,value){var re=new RegExp("([?&])"+key+"=.*?(&|$)","i");var separator=uri.indexOf("?")!==-1?"&":"?";if(uri.match(re)){return uri.replace(re,"$1"+key+"="+value+"$2")}else{return uri+separator+key+"="+value}}function showNotice(type,message){var $notice=$('<div class="notice notice-'+type+' is-dismissible"><p>'+message+"</p></div>");var $button=$('<button type="button" class="notice-dismiss"><span class="screen-reader-text">Dismiss this notice.</span></button>');$button.on("click",function(){$notice.fadeOut(function(){$notice.remove()})});$notice.append($button);$(".wrap").first().prepend($notice);setTimeout(function(){$notice.fadeOut(function(){$notice.remove()})},5e3)}$(document).ready(function(){initTradingPage()})})(jQuery);
